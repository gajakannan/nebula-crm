# Insurance CRM — Single Source of Truth Master Build Spec (Blueprint Prompt)

You are an AI development partner helping me create a production-grade Commercial P&C Insurance CRM.
This document is the ONLY source of truth. Do not rely on any other spec packages unless explicitly told to.
If information is missing, ask questions or mark TODOs — do NOT invent business rules.

## 0) How we will work (Process + Roles)

We will proceed in three explicit phases. You must stay within the current phase.

### Phase A — Product Manager Mode (PM/BA)
Goal: define product requirements (vision, users, epics, features, stories, acceptance criteria).
Output: a complete PM-ready spec section with minimal technical assumptions.

### Phase B — Architect/Tech Lead Mode (Dev/Arch)
Goal: define technical approach (stack, architecture, data model, workflows, APIs, security, NFRs).
Output: a complete build-ready technical spec section that maps to Phase A.

### Phase C — Implementation Mode
Goal: generate the actual repository and code in incremental vertical slices with tests.
Output: production-quality code + migrations + OpenAPI + tests + run instructions.

IMPORTANT RULES:

- Single source of truth is THIS document.
- If a requirement isn’t written here, do not implement it.
- If there is ambiguity, list questions and propose minimal default assumptions labeled clearly.
- No scope creep. Build only what’s specified for the current phase.

---

## 1) Product Context

### 1.1 What we’re building

Name: Nebula

Domain: Commercial Property & Casualty Insurance CRM

Purpose: Manage broker/MGA relationships, accounts, submissions, renewals, activities, reminders, and broker insights.


### 1.2 Target users

- Distribution & Marketing (primary users)
- Underwriters (workflow updates + collaboration)
- Broker Relationship Managers
- MGA Program Managers
- Admin

External users (future): MGA users with limited access (not in Phase 0 MVP unless explicitly stated).

### 1.3 Core entities (baseline)

- Account (insured business)
- Broker
- MGA
- Program
- Contact
- Submission
- Renewal
- Document (versioned)
- ActivityTimelineEvent (immutable audit/timeline)
- WorkflowTransition (immutable append-only transitions)
- UserProfile (internal profile driven by Keycloak subject)
- UserPreference (separate table)

### 1.4 Critical workflows (baseline)

Submission: Received → Triaging → WaitingOnBroker → ReadyForUWReview → InReview → Quoted → BindRequested → Bound (or Declined/Withdrawn)
Renewal: Created → Early → OutreachStarted → InReview → Quoted → Bound (or Lost/Lapsed)

Non-negotiables:

- Audit logging and timeline events are mandatory for every mutation and every workflow transition.
- Role-based visibility is mandatory: InternalOnly vs BrokerVisible content separation.

---

## 2) Technology and Platform (baseline decisions)

These are locked unless explicitly changed later:

- Frontend: React 18 + TypeScript + Vite + Tailwind + shadcn/ui
- State: TanStack Query, React Hook Form, AJV (JSON Schema validation)
- Backend: C# / .NET 10 Minimal APIs
- Database: PostgreSQL (dev + prod)
- ORM: EF Core 10
- AuthN: Keycloak (OIDC/JWT)
- AuthZ: Casbin ABAC enforced server-side
- Workflow engine: Temporal (included in Phase 0)
- Deploy: Docker + docker-compose
- Agentic ops: Python MCP server (later, secondary interface; never source of truth)
- Testing:
  - Frontend: Vitest (unit/component), Playwright (E2E browser), @axe-core/playwright (a11y), Lighthouse CI (performance)
  - Backend: xUnit (unit/integration), Testcontainers (database), Bruno CLI (API collections), Coverlet (coverage), k6 (load)
  - AI/Neuron: pytest (unit/integration/evaluation), pytest-benchmark (performance), custom evaluation metrics
  - Cross-cutting: Pact.NET (contract testing), OWASP ZAP (security), Trivy (vulnerability scanning)

Architecture constraints:

- Clean Architecture: Domain → Application → Infrastructure → API
- Application depends on repository interfaces; Infrastructure implements with EF.
- Audit/timeline/transition tables are append-only (immutable).
- Reference data uses tables + deterministic seed data (not hardcoded enums when configurable).
- API error contract must be consistent across all services.

---

## 3) Phase A — Product Manager Spec (Current Baseline)

Status: This repository is currently focused on the agent builder framework, and the Nebula CRM reference implementation is **in Phase C implementation** for F0001 (Dashboard) and F0002 (Broker Relationship Management). Task write endpoints exist in the contract but are not registered (404) until F0003 is activated. Phase A remains the baseline spec and Phase B is approved.

### 3.1 Vision + Non-Goals

- Vision:
  - Provide a single operating system for commercial P&C distribution teams to manage broker/MGA relationships, accounts, submissions, renewals, and activity history with strong auditability.
  - Replace spreadsheet/email-driven processes with structured workflows, permission-aware collaboration, and traceable transitions.
  - Deliver a modular foundation that supports AI-assisted workflows later without changing the source-of-truth system.

- Non-goals (explicit):
  - No external broker/MGA self-service portal in MVP.
  - No advanced analytics dashboards beyond basic broker insight summaries in MVP.
  - No document OCR/intelligence workflows in MVP.
  - No claims management module in MVP.
  - No multi-region regulatory rules engine in MVP.

### 3.2 Personas

- Persona 1: Distribution user
  - Primary job: intake and triage submissions, manage broker interactions, track pipeline movement.
  - Success metric: reduced intake turnaround and fewer handoff delays.

- Persona 2: Underwriter
  - Primary job: review triaged submissions, provide quote/bind decisions, maintain decision traceability.
  - Success metric: faster, consistent movement from ReadyForUWReview to Quoted/Bound or Declined.

- Persona 3: Relationship Manager
  - Primary job: maintain broker/account relationships, contacts, and timeline context.
  - Success metric: complete broker/account context available in one place.

- Persona 4: Program Manager
  - Primary job: oversee MGA/program-level relationships and program performance signals.
  - Success metric: program-level visibility with clear ownership and activity traces.

### 3.3 Features

**Note:** Features are organized as self-contained folders in `planning-mds/features/F{NNNN}-{slug}/` using the feature templates. Each folder includes `PRD.md`, `README.md`, `STATUS.md`, `GETTING-STARTED.md`, and colocated story files.

**MVP Features:**
- [F0001: Dashboard](features/F0001-dashboard/PRD.md) - Draft ready
- [F0002: Broker & MGA Relationship Management](features/F0002-broker-relationship-management/PRD.md) - Draft ready
- [F0003: Task Center + Reminders](features/F0003-task-center/PRD.md) - MVP (API-only)
- F0005: Account 360 & Activity Timeline - Planned
- F0006: Submission Intake Workflow - Planned
- F0007: Renewal Pipeline - Planned
- F0008: Broker Insights - Planned
- [F0004: Task Center UI + Manager Assignment](features/F0004-task-center-ui-and-assignment/PRD.md) - Planned

### 3.4 MVP Features and Stories (vertical-slice friendly)

**Note:** User stories are written as separate markdown files organized by feature in `planning-mds/features/{feature-name}/` directories using the story template (`agents/templates/story-template.md`). Each story includes: description, acceptance criteria, edge cases, roles, and audit/timeline requirements.

**MVP Stories (Feature F0001: Dashboard):**
- [F0001-S0001: View Key Metrics Cards](features/F0001-dashboard/F0001-S0001-view-key-metrics-cards.md) - Draft ready
- [F0001-S0002: View Pipeline Summary (Mini-Kanban)](features/F0001-dashboard/F0001-S0002-view-pipeline-summary.md) - Draft ready
- [F0001-S0003: View My Tasks and Reminders](features/F0001-dashboard/F0001-S0003-view-my-tasks-and-reminders.md) - Draft ready
- [F0001-S0004: View Broker Activity Feed](features/F0001-dashboard/F0001-S0004-view-broker-activity-feed.md) - Draft ready
- [F0001-S0005: View Nudge Cards](features/F0001-dashboard/F0001-S0005-view-nudge-cards.md) - Draft ready

**MVP Stories (Feature F0002: Broker Relationship Management):**
- [F0002-S0001: Create Broker](features/F0002-broker-relationship-management/F0002-S0001-create-broker.md) - Draft ready
- [F0002-S0002: Search Brokers](features/F0002-broker-relationship-management/F0002-S0002-search-brokers.md) - Draft ready
- [F0002-S0003: Read Broker (Broker 360 View)](features/F0002-broker-relationship-management/F0002-S0003-read-broker.md) - Draft ready
- [F0002-S0004: Update Broker](features/F0002-broker-relationship-management/F0002-S0004-update-broker.md) - Draft ready
- [F0002-S0005: Delete Broker](features/F0002-broker-relationship-management/F0002-S0005-delete-broker.md) - Draft ready
- [F0002-S0006: Manage Broker Contacts](features/F0002-broker-relationship-management/F0002-S0006-manage-broker-contacts.md) - Draft ready
- [F0002-S0007: View Broker Activity Timeline](features/F0002-broker-relationship-management/F0002-S0007-view-broker-activity-timeline.md) - Draft ready

**MVP Stories (Feature F0003: Task Center + Reminders — API-only):**
- [F0003-S0001: Create Task](features/F0003-task-center/F0003-S0001-create-task.md) - Draft ready
- [F0003-S0002: Update Task](features/F0003-task-center/F0003-S0002-update-task.md) - Draft ready
- [F0003-S0003: Delete Task](features/F0003-task-center/F0003-S0003-delete-task.md) - Draft ready

**Story Index:** See `planning-mds/features/STORY-INDEX.md` for auto-generated summary of all stories (if generated).

Reference examples also live under `planning-mds/examples/stories/`.

### 3.5 Screen list (MVP)

- Navigation Shell
- Dashboard
- Broker List
- Broker 360
- Task Center (optional MVP)
- Admin minimal (roles/policies optional MVP)

Screen baseline details:
- Navigation Shell: authenticated app shell, role-aware navigation, global search entry, notifications placeholder.
- Dashboard: role-aware landing screen with five widgets — nudge cards (dismissible action prompts for time-sensitive items), KPI metrics cards, pipeline summary (mini-Kanban with status pills and expandable card previews), my tasks & reminders, and broker activity feed. All widgets enforce ABAC scope and degrade gracefully when upstream entities are unavailable.
- Broker List: sortable/filterable list, quick search, create action, status tags.
- Broker 360: profile header, contacts, hierarchy/program links, immutable timeline panel.
- Task Center: assigned tasks, due dates, simple status states, reminder hooks.
- Admin minimal: role assignment visibility and policy diagnostics (read-focused in MVP).

---

## 4) Phase B — Architect Spec (Public Baseline)

**Status: APPROVED (2026-02-14)** — Dashboard-first architecture approved as the planning baseline. Phase C implementation is in progress for F0001/F0002; keep planning artifacts current during implementation.

This section defines the build-ready technical baseline for the reference implementation.

**Architecture Decision Records:** See `planning-mds/architecture/decisions/` for detailed ADRs:
- [ADR-001](architecture/decisions/ADR-001-json-schema-validation.md) — JSON Schema Validation
- [ADR-Auth](architecture/decisions/ADR-Authentication-Strategy.md) — Authentication Strategy (Keycloak)
- [ADR-Token](architecture/decisions/ADR-Auth-Token-Storage.md) — Auth Token Storage (Hybrid)
- [ADR-002](architecture/decisions/ADR-002-dashboard-data-aggregation.md) — Dashboard Data Aggregation (per-widget endpoints)
- [ADR-003](architecture/decisions/ADR-003-task-entity-nudge-engine.md) — Task Entity & Nudge Engine
- [ADR-004](architecture/decisions/ADR-004-frontend-dashboard-widget-architecture.md) — Frontend Dashboard Widget Architecture

**Data Model Supplement:** See `planning-mds/architecture/data-model.md` for Task entity, dashboard indexes, and query patterns.

### 4.1 Service boundaries

- Architecture shape: modular monolith (single deployable) with clean module boundaries and internal APIs.
- **Dashboard module (F0001):**
  - Owns dashboard-specific read endpoints (KPIs, pipeline summary, nudges).
  - Reads across BrokerRelationship, Submission, Renewal, TaskManagement, and TimelineAudit modules.
  - No owned entities — purely a query/aggregation layer.
  - See [ADR-002](architecture/decisions/ADR-002-dashboard-data-aggregation.md) for per-widget endpoint design.
- **TaskManagement module (F0001 + F0003):**
  - Owns the Task entity (CRUD + status transitions).
  - Provides `GET /api/my/tasks` for dashboard and Task Center.
  - All Task mutations generate ActivityTimelineEvent records.
  - See [ADR-003](architecture/decisions/ADR-003-task-entity-nudge-engine.md) for entity design.
- BrokerRelationship module:
  - Owns Broker, Contact, MGA, Program relationship mappings.
  - Handles broker/contact CRUD, hierarchy links, broker search.
- Account module:
  - Owns Account profile and account-level relationship views.
  - Provides account context for submissions and renewals.
- Submission module:
  - Owns Submission aggregate and Submission workflow operations.
  - Enforces transition gates/checklists before status moves.
- Renewal module:
  - Owns Renewal aggregate and Renewal workflow operations.
  - Tracks outreach and renewal-specific lifecycle.
- TimelineAudit module:
  - Owns ActivityTimelineEvent and WorkflowTransition append-only records.
  - Provides timeline query/read APIs (including `GET /api/timeline/events` for dashboard activity feed).
- IdentityAuthorization module:
  - Validates Keycloak tokens and resolves subject attributes.
  - Enforces Casbin ABAC policies at API/application boundaries.

### 4.2 Data model (detailed)

Define tables/fields for:

- Broker, Contact, UserProfile, UserPreference, ActivityTimelineEvent, WorkflowTransition
- Reference tables + seed strategy

Core entities (minimum baseline):
- Account
  - Id (uuid), Name, Industry, PrimaryState, Region, Status
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- Broker
  - Id (uuid), LegalName, LicenseNumber, State, Status, ManagedBySubject (nullable)
  - MgaId (nullable), PrimaryProgramId (nullable)
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- BrokerRegion (new — multi-region broker scope)
  - BrokerId (uuid), Region (string)
  - Composite PK (BrokerId, Region)
- MGA
  - Id (uuid), Name, ExternalCode, Status
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- Program
  - Id (uuid), Name, ProgramCode, MgaId, ManagedBySubject (nullable)
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- Contact
  - Id (uuid), BrokerId (nullable), AccountId (nullable), FullName, Email, Phone, Role
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- Submission
  - Id (uuid), AccountId, BrokerId, ProgramId (nullable), CurrentStatus, EffectiveDate, PremiumEstimate, AssignedTo (Keycloak subject)
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- Renewal
  - Id (uuid), AccountId, BrokerId, SubmissionId (nullable), CurrentStatus, RenewalDate, AssignedTo (Keycloak subject)
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, IsDeleted
- **Task** (new — required by Dashboard F0001 and Task Center F0003)
  - Id (uuid), Title, Description (nullable), Status (Open/InProgress/Done), Priority (Low/Normal/High/Urgent)
  - DueDate (nullable), AssignedTo (Keycloak subject)
  - LinkedEntityType (nullable), LinkedEntityId (nullable) — polymorphic link to Broker/Submission/Renewal/Account
  - CreatedAt, CreatedBy, UpdatedAt, UpdatedBy, CompletedAt (nullable), IsDeleted
  - See [data-model.md](architecture/data-model.md) for full table definition, indexes, and audit requirements
- UserProfile
  - Subject (Keycloak sub), Email, DisplayName, Department, RegionsJson, RolesJson
  - CreatedAt, UpdatedAt
- UserPreference
  - Id (uuid), Subject, PreferenceKey, PreferenceValueJson
  - CreatedAt, UpdatedAt
- ActivityTimelineEvent (append-only)
  - Id (uuid), EntityType, EntityId, EventType, EventPayloadJson, ActorSubject, OccurredAt
- WorkflowTransition (append-only)
  - Id (uuid), WorkflowType, EntityId, FromState, ToState, Reason, ActorSubject, OccurredAt

Reference tables and seed strategy:
- ReferenceState, ReferenceIndustry, ReferenceTaskStatus, ReferenceSubmissionStatus, ReferenceRenewalStatus
- See [data-model.md Section 1.2](architecture/data-model.md) for complete seed definitions including status descriptions, terminal flags, and display metadata.
- Deterministic EF seed/migration scripts with idempotent upsert semantics.
- Runtime writes to reference tables are restricted to admin-only actions.

### 4.3 Workflow rules

Define allowed transitions and gating validations (Submission and Renewal).

Submission workflow transitions:
- Received -> Triaging
- Triaging -> WaitingOnBroker or ReadyForUWReview
- WaitingOnBroker -> ReadyForUWReview
- ReadyForUWReview -> InReview
- InReview -> Quoted or Declined
- Quoted -> BindRequested or Withdrawn
- BindRequested -> Bound or Declined

Renewal workflow transitions:
- Created -> Early
- Early -> OutreachStarted
- OutreachStarted -> InReview
- InReview -> Quoted or Lost
- Quoted -> Bound or Lapsed

Transition rules and validations:
- Invalid transition pairs return HTTP 409 with `ProblemDetails` (`code=invalid_transition`).
- Missing required checklist/data preconditions return HTTP 409 with `ProblemDetails` (`code=missing_transition_prerequisite`).
- Subject must have permission for the requested transition action (otherwise HTTP 403).
- Submission/renewal creation must validate region alignment: `Account.Region` must be included in the broker's `BrokerRegion` set; otherwise return HTTP 400 with `ProblemDetails` (`code=region_mismatch`).
- Every successful transition appends:
  - one WorkflowTransition record
  - one ActivityTimelineEvent record
- Transition records are immutable; corrections happen via compensating transitions.

### 4.4 Authorization model (ABAC)

Define subject attributes (from UserProfile), resource attributes, actions.
Define minimal policies for Phase 0 and Phase 1.

Subject attributes (from JWT + UserProfile):
- subjectId, roles, department, regions, internalUser flag

Resource attributes:
- resourceType, ownerAccountId, brokerId, programId, accountRegion, internalOnly flag, workflowState

Actions (examples):
- broker:create, broker:read, broker:update, broker:delete
- contact:create, contact:read, contact:update, contact:delete
- submission:transition, renewal:transition
- timeline:read

Policy baseline:
- Internal distribution and relationship roles can create/read/update Broker and Contact.
- Underwriters have read access to broker/account context and transition access within underwriting stages.
- Admin has broad management access including policy administration.
- InternalOnly resources are denied to non-internal subjects.
- Enforcement is server-side only via Casbin middleware and application guards.

### 4.5 API Contracts

Define endpoints + request/response contracts + error contract.

Primary OpenAPI contract:
- `planning-mds/api/nebula-api.yaml`

Entity coverage in API surface:
- Account, Broker, MGA, Program, Contact, Submission, Renewal, ActivityTimelineEvent, WorkflowTransition

MVP endpoint pattern examples:
- GET `/api/brokers`
- POST `/api/brokers`
- GET `/api/brokers/{brokerId}`
- PUT `/api/brokers/{brokerId}`
- DELETE `/api/brokers/{brokerId}`
- GET `/api/contacts`
- POST `/api/contacts`
- GET `/api/submissions/{submissionId}/transitions`
- POST `/api/submissions/{submissionId}/transitions`
- GET `/api/renewals/{renewalId}/transitions`
- POST `/api/renewals/{renewalId}/transitions`

Dashboard endpoints (F0001 — per-widget, see [ADR-002](architecture/decisions/ADR-002-dashboard-data-aggregation.md)):
- GET `/api/dashboard/kpis` — KPI metrics (active brokers, open subs, renewal rate, avg turnaround)
- GET `/api/dashboard/pipeline` — Pipeline summary counts by status
- GET `/api/dashboard/pipeline/{entityType}/{status}/items` — Lazy-loaded mini-cards (max 5)
- GET `/api/dashboard/nudges` — Prioritized nudge cards (max 3)
- GET `/api/my/tasks` — Tasks assigned to authenticated user
- GET `/api/timeline/events?entityType=Broker&limit=20` — Broker activity feed

Task CRUD endpoints (F0001 + F0003):
- POST `/api/tasks` — Create task
- GET `/api/tasks/{taskId}` — Get task
- PUT `/api/tasks/{taskId}` — Update task
- DELETE `/api/tasks/{taskId}` — Soft delete task

Error contract:
- All non-success responses return RFC 7807 `ProblemDetails` with `type`, `title`, `status`, plus extension fields `code`, `traceId`, and optional `detail`/`errors`.

### 4.6 Observability + NFRs

Logging, tracing, metrics, performance, security.

Observability baseline:
- Structured logging with correlation id and subject id where available.
- Distributed traces for API request path and DB calls.
- Metrics: request latency, error rate, transition counts, authorization denials.

Performance:
- API read endpoints: p95 < 300ms under nominal load.
- API write/transition endpoints: p95 < 500ms under nominal load.
- List endpoints support pagination and bounded query size.

Security:
- OIDC JWT validation against Keycloak issuer/audience.
- Casbin ABAC for all protected actions.
- Secrets via environment variables; no hardcoded credentials in code or config.
- Immutable audit trail for every mutation and transition.

Availability:
- Target service availability 99.9% for production environments.
- Health/readiness endpoints for orchestration.

Scalability:
- Horizontal API scaling behind stateless app instances.
- Database indexing on high-cardinality lookup fields (license number, status, foreign keys).
- Transition/timeline tables partition-ready for growth.

---

## 5) Phase C — Implementation Plan (locked order)

Implementation should proceed in staged increments. Start Phase 0 foundation when lifecycle stage transitions to `implementation` in `lifecycle-stage.yaml`; track calendar commitments in project-specific execution plans rather than this baseline spec.

### Phase 0 Foundation — required components

Must include Postgres + Keycloak + Casbin in docker-compose. Temporal is included as infrastructure-only
(server + worker containers); no F0001/F0002 story uses Temporal workflows — it is provisioned now so that
Submission/Renewal workflow orchestration (F0006/F0007) can adopt it without docker-compose changes later.
Backend: Clean Architecture scaffold + auth + ABAC wiring + error contract + timeline append-only.
Frontend: authenticated shell.
Tests: auth test + timeline append test.

No scope creep in Phase 0:

- No submission/renewal UI
- No document upload implementation
- No analytics
- No external MGA portal
- No Python MCP server

Definition of Done for Phase 0:

- [ ] docker-compose includes Postgres, Keycloak, Casbin policy source, Temporal (infrastructure-only; no app code depends on it in F0001/F0002)
- [ ] backend scaffolded with clean architecture boundaries and auth/ABAC wiring
- [ ] frontend authenticated shell with protected routes
- [ ] consistent error contract implemented across API endpoints
- [ ] append-only timeline and workflow transition persistence in place
- [ ] baseline tests passing: auth enforcement + timeline append + one transition flow
- [ ] run instructions and local setup documented

---

## 6) Next Step Guidance

Drive the next action from the declared lifecycle stage in `lifecycle-stage.yaml`:

- If stage is `framework-bootstrap` or `planning`: ask the smallest set of questions needed to complete sections 3.1–3.5, then propose a first-pass draft of Vision, Non-goals, Personas, Epics, and MVP stories.
- If stage is `implementation` or `release-readiness`: use approved planning and architecture artifacts to execute implementation/review actions and collect gate evidence.
