openapi: 3.0.3
info:
  title: Nebula API
  version: 0.3.1
  description: |
    Public baseline API contract for the Nebula insurance CRM reference implementation.
    Version 0.3.1 adds Submission/Renewal detail endpoints.
servers:
  - url: https://api.nebula.local
security:
  - bearerAuth: []
tags:
  - name: Brokers
    description: Broker CRUD operations
  - name: Contacts
    description: Contact CRUD operations
  - name: Accounts
    description: Account operations
  - name: MGAs
    description: MGA operations
  - name: Programs
    description: Program operations
  - name: Submissions
    description: Submission workflow operations
  - name: Renewals
    description: Renewal workflow operations
  - name: Dashboard
    description: Dashboard widget data endpoints (F0)
  - name: Tasks
    description: Task CRUD for My Tasks widget and Task Center
  - name: Timeline
    description: Activity timeline event queries

paths:
  # ──────────────────────────────────────────────────────────────
  # Broker endpoints (existing)
  # ──────────────────────────────────────────────────────────────
  /api/brokers:
    get:
      operationId: listBrokers
      summary: List brokers
      tags: [Brokers]
      parameters:
        - $ref: "#/components/parameters/BrokerSearchQuery"
        - $ref: "#/components/parameters/BrokerStatusFilter"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: Paginated broker list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedBrokerList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: createBroker
      summary: Create broker
      tags: [Brokers]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BrokerCreateRequest"
      responses:
        "201":
          description: Broker created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Broker"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/brokers/{brokerId}:
    parameters:
      - $ref: "#/components/parameters/BrokerId"
    get:
      operationId: getBrokerById
      summary: Get broker by id
      tags: [Brokers]
      responses:
        "200":
          description: Broker details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Broker"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      operationId: updateBroker
      summary: Update broker
      tags: [Brokers]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BrokerUpdateRequest"
      responses:
        "200":
          description: Broker updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Broker"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteBroker
      summary: Delete broker
      description: Soft delete broker. Returns 409 if active submissions or renewals exist.
      tags: [Brokers]
      responses:
        "204":
          description: Broker deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"

  # ──────────────────────────────────────────────────────────────
  # Contact endpoints (existing)
  # ──────────────────────────────────────────────────────────────
  /api/contacts:
    get:
      operationId: listContacts
      summary: List contacts
      description: >
        Returns a paginated list of contacts, optionally filtered by brokerId.
        This endpoint uses a query-parameter filter (not a sub-resource URL) because
        contacts may belong to different brokers and a flat list with filters is
        more flexible for cross-broker search in future phases.
      tags: [Contacts]
      parameters:
        - name: brokerId
          in: query
          required: false
          description: Filter contacts for a specific broker.
          schema:
            type: string
            format: uuid
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: Paginated contact list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedContactList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: createContact
      summary: Create contact
      tags: [Contacts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContactCreateRequest"
      responses:
        "201":
          description: Contact created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/contacts/{contactId}:
    parameters:
      - $ref: "#/components/parameters/ContactId"
    get:
      operationId: getContactById
      summary: Get contact by id
      tags: [Contacts]
      responses:
        "200":
          description: Contact details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      operationId: updateContact
      summary: Update contact
      tags: [Contacts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContactUpdateRequest"
      responses:
        "200":
          description: Contact updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteContact
      summary: Delete contact
      tags: [Contacts]
      responses:
        "204":
          description: Contact deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ──────────────────────────────────────────────────────────────
  # Account, MGA, Program endpoints (existing)
  # ──────────────────────────────────────────────────────────────
  /api/accounts:
    get:
      operationId: listAccounts
      summary: List accounts
      tags: [Accounts]
      responses:
        "200":
          description: Account list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Account"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/mgas:
    get:
      operationId: listMgas
      summary: List MGAs
      tags: [MGAs]
      responses:
        "200":
          description: MGA list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MGA"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/programs:
    get:
      operationId: listPrograms
      summary: List programs
      tags: [Programs]
      responses:
        "200":
          description: Program list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Program"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # ──────────────────────────────────────────────────────────────
  # Submission / Renewal detail endpoints (NEW)
  # ──────────────────────────────────────────────────────────────
  /api/submissions/{submissionId}:
    parameters:
      - $ref: "#/components/parameters/SubmissionId"
    get:
      operationId: getSubmissionById
      summary: Get submission by id
      tags: [Submissions]
      responses:
        "200":
          description: Submission details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Submission"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/renewals/{renewalId}:
    parameters:
      - $ref: "#/components/parameters/RenewalId"
    get:
      operationId: getRenewalById
      summary: Get renewal by id
      tags: [Renewals]
      responses:
        "200":
          description: Renewal details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Renewal"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ──────────────────────────────────────────────────────────────
  # Workflow transition endpoints (existing)
  # ──────────────────────────────────────────────────────────────
  /api/submissions/{submissionId}/transitions:
    parameters:
      - $ref: "#/components/parameters/SubmissionId"
    get:
      operationId: listSubmissionTransitions
      summary: List submission transitions
      tags: [Submissions]
      responses:
        "200":
          description: Submission transition history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WorkflowTransitionRecord"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: transitionSubmission
      summary: Transition submission workflow state
      tags: [Submissions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowTransitionRequest"
      responses:
        "201":
          description: Transition recorded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTransitionRecord"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/renewals/{renewalId}/transitions:
    parameters:
      - $ref: "#/components/parameters/RenewalId"
    get:
      operationId: listRenewalTransitions
      summary: List renewal transitions
      tags: [Renewals]
      responses:
        "200":
          description: Renewal transition history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WorkflowTransitionRecord"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: transitionRenewal
      summary: Transition renewal workflow state
      tags: [Renewals]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowTransitionRequest"
      responses:
        "201":
          description: Transition recorded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTransitionRecord"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"

  # ──────────────────────────────────────────────────────────────
  # Dashboard endpoints (NEW — F0)
  # ──────────────────────────────────────────────────────────────
  /api/dashboard/kpis:
    get:
      operationId: getDashboardKpis
      summary: Get dashboard KPI metrics
      description: |
        Returns aggregated KPI metrics for the dashboard: active broker count,
        open submission count, renewal rate (trailing 90 days), and average
        turnaround days (trailing 90 days). All values are ABAC-scoped to the
        authenticated user's permissions.
      tags: [Dashboard]
      responses:
        "200":
          description: KPI metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DashboardKpis"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/dashboard/pipeline:
    get:
      operationId: getDashboardPipeline
      summary: Get pipeline summary counts
      description: |
        Returns submission and renewal pipeline counts grouped by non-terminal
        status. Used by the Pipeline Summary (mini-Kanban) widget.
        All counts are ABAC-scoped.
      tags: [Dashboard]
      responses:
        "200":
          description: Pipeline summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DashboardPipeline"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/dashboard/pipeline/{entityType}/{status}/items:
    parameters:
      - name: entityType
        in: path
        required: true
        description: Entity type for pipeline items.
        schema:
          type: string
          enum: [submission, renewal]
      - name: status
        in: path
        required: true
        description: Workflow status to filter by.
        schema:
          type: string
    get:
      operationId: getDashboardPipelineItems
      summary: Get pipeline mini-cards for a status
      description: |
        Returns up to 5 mini-card items for a specific pipeline status, sorted
        by days-in-status descending (longest stuck first). Lazy-loaded by the
        frontend on hover/click of a pipeline pill. ABAC-scoped.
      tags: [Dashboard]
      responses:
        "200":
          description: Pipeline mini-card items
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - totalCount
                properties:
                  items:
                    type: array
                    maxItems: 5
                    items:
                      $ref: "#/components/schemas/PipelineMiniCard"
                  totalCount:
                    type: integer
                    description: Total items in this status (for "View all N" link).
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/dashboard/nudges:
    get:
      operationId: getDashboardNudges
      summary: Get nudge cards
      description: |
        Returns up to 3 prioritized nudge cards for the authenticated user.
        Priority order: overdue tasks > stale submissions (>5 days in status) >
        upcoming renewals (within 14 days). All results are ABAC-scoped and
        filtered by task ownership.
      tags: [Dashboard]
      responses:
        "200":
          description: Nudge cards
          content:
            application/json:
              schema:
                type: object
                required:
                  - nudges
                properties:
                  nudges:
                    type: array
                    maxItems: 3
                    items:
                      $ref: "#/components/schemas/NudgeCard"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # ──────────────────────────────────────────────────────────────
  # Task endpoints (NEW — F0 + F5)
  # ──────────────────────────────────────────────────────────────
  /api/my/tasks:
    get:
      operationId: getMyTasks
      summary: Get tasks assigned to the authenticated user
      description: |
        Returns tasks assigned to the current user (matched by Keycloak subject),
        filtered to Open and InProgress status, sorted by DueDate ascending
        (soonest first, nulls last). Used by the My Tasks dashboard widget.
      tags: [Tasks]
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of tasks to return.
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        "200":
          description: User's tasks
          content:
            application/json:
              schema:
                type: object
                required:
                  - tasks
                  - totalCount
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: "#/components/schemas/TaskSummary"
                  totalCount:
                    type: integer
                    description: Total open/in-progress tasks (for "View all" link).
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/tasks:
    post:
      operationId: createTask
      summary: Create a task
      tags: [Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreateRequest"
      responses:
        "201":
          description: Task created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/tasks/{taskId}:
    parameters:
      - $ref: "#/components/parameters/TaskId"
    get:
      operationId: getTaskById
      summary: Get task by id
      tags: [Tasks]
      responses:
        "200":
          description: Task details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      operationId: updateTask
      summary: Update task
      tags: [Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskUpdateRequest"
      responses:
        "200":
          description: Task updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteTask
      summary: Soft delete task
      tags: [Tasks]
      responses:
        "204":
          description: Task deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ──────────────────────────────────────────────────────────────
  # Timeline endpoints (NEW — dashboard activity feed)
  # ──────────────────────────────────────────────────────────────
  /api/timeline/events:
    get:
      operationId: listTimelineEvents
      summary: List timeline events
      description: |
        Returns recent ActivityTimelineEvents filtered by entity type.
        Used by the Broker Activity Feed dashboard widget and by entity 360 views.
        All results are ABAC-scoped.
      tags: [Timeline]
      parameters:
        - name: entityType
          in: query
          required: true
          description: Filter events by entity type.
          schema:
            type: string
            enum: [Broker, Account, Submission, Renewal, Task]
        - name: entityId
          in: query
          required: false
          description: Filter events for a specific entity.
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of events to return.
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Timeline events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TimelineEvent"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    BrokerSearchQuery:
      name: q
      in: query
      required: false
      description: Case-insensitive broker name search. License number search is exact match only. Leading/trailing spaces are trimmed.
      schema:
        type: string
        minLength: 1
        maxLength: 100
    BrokerStatusFilter:
      name: status
      in: query
      required: false
      description: Optional broker status filter.
      schema:
        type: string
        enum:
          - Active
          - Inactive
    BrokerId:
      name: brokerId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ContactId:
      name: contactId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    SubmissionId:
      name: submissionId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    RenewalId:
      name: renewalId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    TaskId:
      name: taskId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    Page:
      name: page
      in: query
      required: false
      description: Page number (1-based).
      schema:
        type: integer
        minimum: 1
        default: 1
    PageSize:
      name: pageSize
      in: query
      required: false
      description: Items per page.
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    BadRequest:
      description: Invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Forbidden:
      description: Authenticated but not allowed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Conflict:
      description: Conflict with current state (for example invalid transition)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

  schemas:
    # ── Error Contract ──────────────────────────────────────────
    ProblemDetails:
      type: object
      description: RFC 7807 problem details payload with Nebula-specific extension fields.
      required:
        - type
        - title
        - status
        - code
        - traceId
      properties:
        type:
          type: string
          format: uri
          description: URI reference that identifies the problem type.
        title:
          type: string
          description: Short, human-readable summary of the problem.
        status:
          type: integer
          minimum: 400
          maximum: 599
          description: HTTP status code generated for this problem instance.
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence.
        instance:
          type: string
          format: uri
          description: URI reference identifying this specific occurrence.
        code:
          type: string
          description: Stable machine-readable domain error code.
        traceId:
          type: string
          description: Correlation identifier for diagnostics and tracing.
        errors:
          type: object
          description: Optional validation error map keyed by field.
          additionalProperties:
            type: array
            items:
              type: string

    # ── Broker Schemas ──────────────────────────────────────────
    Broker:
      type: object
      description: >
        Broker profile. If Status=Inactive, email and phone fields are returned
        as null (masking sentinel). The frontend should display these as "Masked"
        or equivalent placeholder text rather than treating them as absent data.
      required:
        - id
        - legalName
        - licenseNumber
        - state
        - status
      properties:
        id:
          type: string
          format: uuid
        legalName:
          type: string
        licenseNumber:
          type: string
        state:
          type: string
        status:
          type: string
          enum:
            - Active
            - Inactive
            - Pending
        email:
          type: string
          format: email
          nullable: true
          description: >
            Returned as null when Status=Inactive (masking sentinel).
            Consumers must treat null on an inactive broker as "masked", not "missing".
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{7,14}$"
          nullable: true
          description: >
            Returned as null when Status=Inactive (masking sentinel).
            Consumers must treat null on an inactive broker as "masked", not "missing".
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BrokerCreateRequest:
      type: object
      description: Payload to create a broker.
      required:
        - legalName
        - licenseNumber
        - state
      properties:
        legalName:
          type: string
          minLength: 1
          maxLength: 255
        licenseNumber:
          type: string
          minLength: 1
          maxLength: 50
        state:
          type: string
          pattern: "^[A-Z]{2}$"
          description: Two-letter US state code (e.g. CA, NY).
        email:
          type: string
          format: email
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{7,14}$"

    BrokerUpdateRequest:
      type: object
      description: Payload to update a broker. License number is immutable after creation.
      required:
        - legalName
        - state
        - status
      properties:
        legalName:
          type: string
          minLength: 1
          maxLength: 255
        state:
          type: string
          pattern: "^[A-Z]{2}$"
          description: Two-letter US state code (e.g. CA, NY).
        status:
          type: string
          enum:
            - Active
            - Inactive
            - Pending
        email:
          type: string
          format: email
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{7,14}$"

    PaginatedBrokerList:
      type: object
      description: Paginated list of brokers.
      required:
        - data
        - page
        - pageSize
        - totalCount
        - totalPages
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Broker"
        page:
          type: integer
        pageSize:
          type: integer
        totalCount:
          type: integer
        totalPages:
          type: integer

    # ── Contact Schemas ─────────────────────────────────────────
    Contact:
      type: object
      description: Contact record.
      required:
        - id
        - fullName
        - email
        - phone
      properties:
        id:
          type: string
          format: uuid
        brokerId:
          type: string
          format: uuid
        accountId:
          type: string
          format: uuid
          nullable: true
        fullName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{7,14}$"
        role:
          type: string

    ContactCreateRequest:
      type: object
      description: Payload to create a contact.
      required:
        - brokerId
        - fullName
        - email
        - phone
      properties:
        brokerId:
          type: string
          format: uuid
        fullName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{7,14}$"
        role:
          type: string

    ContactUpdateRequest:
      type: object
      description: Payload to update a contact.
      required:
        - fullName
        - email
        - phone
      properties:
        fullName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        role:
          type: string

    PaginatedContactList:
      type: object
      description: Paginated list of contacts.
      required:
        - data
        - page
        - pageSize
        - totalCount
        - totalPages
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Contact"
        page:
          type: integer
        pageSize:
          type: integer
        totalCount:
          type: integer
        totalPages:
          type: integer

    # ── Account / MGA / Program Schemas ─────────────────────────
    Account:
      type: object
      description: Insured account profile.
      required:
        - id
        - name
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
        industry:
          type: string

    MGA:
      type: object
      description: MGA profile.
      required:
        - id
        - name
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string

    Program:
      type: object
      description: Insurance program profile.
      required:
        - id
        - name
        - mgaId
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        mgaId:
          type: string
          format: uuid

    # ── Submission / Renewal Schemas ───────────────────────────
    Submission:
      type: object
      description: Submission workflow entity.
      required:
        - id
        - accountId
        - brokerId
        - currentStatus
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        accountId:
          type: string
          format: uuid
        brokerId:
          type: string
          format: uuid
        programId:
          type: string
          format: uuid
          nullable: true
        currentStatus:
          type: string
          enum:
            - Received
            - Triaging
            - WaitingOnBroker
            - ReadyForUWReview
            - InReview
            - Quoted
            - BindRequested
            - Bound
            - Declined
            - Withdrawn
        effectiveDate:
          type: string
          format: date
          nullable: true
        premiumEstimate:
          type: number
          format: double
          nullable: true
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
          description: Keycloak subject of creator.
        updatedAt:
          type: string
          format: date-time
        updatedBy:
          type: string
          description: Keycloak subject of last updater.

    Renewal:
      type: object
      description: Renewal workflow entity.
      required:
        - id
        - accountId
        - brokerId
        - currentStatus
        - renewalDate
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        accountId:
          type: string
          format: uuid
        brokerId:
          type: string
          format: uuid
        submissionId:
          type: string
          format: uuid
          nullable: true
        currentStatus:
          type: string
          enum:
            - Created
            - Early
            - OutreachStarted
            - InReview
            - Quoted
            - Bound
            - Lost
            - Lapsed
        renewalDate:
          type: string
          format: date
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
          description: Keycloak subject of creator.
        updatedAt:
          type: string
          format: date-time
        updatedBy:
          type: string
          description: Keycloak subject of last updater.

    # ── Workflow Schemas ────────────────────────────────────────
    WorkflowTransitionRequest:
      type: object
      description: Request to transition workflow state.
      required:
        - toState
      properties:
        toState:
          type: string
        reason:
          type: string

    WorkflowTransitionRecord:
      type: object
      description: Immutable workflow transition record.
      required:
        - id
        - workflowType
        - entityId
        - fromState
        - toState
        - occurredAt
      properties:
        id:
          type: string
          format: uuid
        workflowType:
          type: string
        entityId:
          type: string
          format: uuid
        fromState:
          type: string
        toState:
          type: string
        reason:
          type: string
        occurredAt:
          type: string
          format: date-time

    # ── Dashboard Schemas (NEW) ─────────────────────────────────
    DashboardKpis:
      type: object
      description: Aggregated KPI metrics for the dashboard.
      required:
        - activeBrokers
        - openSubmissions
        - renewalRate
        - avgTurnaroundDays
      properties:
        activeBrokers:
          type: integer
          description: Count of brokers with Status=Active, ABAC-scoped.
          example: 142
        openSubmissions:
          type: integer
          description: Count of submissions in non-terminal status, ABAC-scoped.
          example: 38
        renewalRate:
          type: number
          format: double
          nullable: true
          description: |
            Percentage of renewals reaching Bound out of all renewals
            that exited the pipeline in trailing 90 days. Null if no data.
          example: 72.5
        avgTurnaroundDays:
          type: number
          format: double
          nullable: true
          description: |
            Mean calendar days from Submission.CreatedAt to first terminal
            state transition, trailing 90 days. Null if no data.
          example: 4.2

    DashboardPipeline:
      type: object
      description: Pipeline summary counts grouped by status.
      required:
        - submissions
        - renewals
      properties:
        submissions:
          type: array
          description: Submission pipeline status counts (non-terminal only).
          items:
            $ref: "#/components/schemas/PipelineStatusCount"
        renewals:
          type: array
          description: Renewal pipeline status counts (non-terminal only).
          items:
            $ref: "#/components/schemas/PipelineStatusCount"

    PipelineStatusCount:
      type: object
      description: Count of entities in a specific workflow status.
      required:
        - status
        - count
        - colorGroup
      properties:
        status:
          type: string
          description: Workflow status label.
          example: WaitingOnBroker
        count:
          type: integer
          minimum: 0
          example: 5
        colorGroup:
          type: string
          description: UI color group for the status pill.
          enum: [intake, triage, waiting, review, decision]

    PipelineMiniCard:
      type: object
      description: Compact item card for pipeline popover.
      required:
        - entityId
        - entityName
        - daysInStatus
      properties:
        entityId:
          type: string
          format: uuid
        entityName:
          type: string
          description: Account or Broker name.
          example: Acme Corp
        amount:
          type: number
          format: double
          nullable: true
          description: Premium estimate (submissions) or null (renewals).
          example: 45000
        daysInStatus:
          type: integer
          minimum: 0
          description: Calendar days since last transition to current status.
          example: 12
        assignedUserInitials:
          type: string
          maxLength: 2
          description: Two-character initials of assigned user.
          example: JM
        assignedUserDisplayName:
          type: string
          description: Full display name (for tooltip).
          example: John Miller

    NudgeCard:
      type: object
      description: A prioritized action prompt for the dashboard.
      required:
        - nudgeType
        - title
        - description
        - linkedEntityType
        - linkedEntityId
        - linkedEntityName
        - urgencyValue
        - ctaLabel
      properties:
        nudgeType:
          type: string
          enum: [OverdueTask, StaleSubmission, UpcomingRenewal]
        title:
          type: string
          description: Nudge card title.
          example: Follow up with Acme Insurance
        description:
          type: string
          description: Urgency context.
          example: 3 days overdue
        linkedEntityType:
          type: string
          description: Type of linked entity for CTA navigation.
          example: Broker
        linkedEntityId:
          type: string
          format: uuid
        linkedEntityName:
          type: string
          description: Display name for context.
          example: Acme Insurance
        urgencyValue:
          type: integer
          description: |
            Days overdue (OverdueTask), days stuck (StaleSubmission),
            or days until renewal (UpcomingRenewal).
          example: 3
        ctaLabel:
          type: string
          description: Call-to-action button label.
          example: Review Now

    # ── Task Schemas (NEW) ──────────────────────────────────────
    Task:
      type: object
      description: Task entity.
      required:
        - id
        - title
        - status
        - priority
        - assignedTo
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [Open, InProgress, Done]
        priority:
          type: string
          enum: [Low, Normal, High, Urgent]
        dueDate:
          type: string
          format: date
          nullable: true
        assignedTo:
          type: string
          description: Keycloak subject of assigned user.
        linkedEntityType:
          type: string
          nullable: true
        linkedEntityId:
          type: string
          format: uuid
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    TaskSummary:
      type: object
      description: Compact task representation for dashboard widget.
      required:
        - id
        - title
        - status
        - dueDate
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        status:
          type: string
          enum: [Open, InProgress]
        dueDate:
          type: string
          format: date
          nullable: true
        linkedEntityType:
          type: string
          nullable: true
        linkedEntityId:
          type: string
          format: uuid
          nullable: true
        linkedEntityName:
          type: string
          nullable: true
          description: Resolved display name of linked entity.
        isOverdue:
          type: boolean
          description: True if DueDate < today and status is not Done.

    TaskCreateRequest:
      type: object
      description: Payload to create a task.
      required:
        - title
        - assignedTo
      properties:
        title:
          type: string
          maxLength: 255
        description:
          type: string
          maxLength: 2000
        priority:
          type: string
          enum: [Low, Normal, High, Urgent]
          default: Normal
        dueDate:
          type: string
          format: date
        assignedTo:
          type: string
          description: Keycloak subject of user to assign.
        linkedEntityType:
          type: string
        linkedEntityId:
          type: string
          format: uuid

    TaskUpdateRequest:
      type: object
      description: Payload to update a task.
      required: []
      minProperties: 1
      properties:
        title:
          type: string
          maxLength: 255
        description:
          type: string
          maxLength: 2000
        status:
          type: string
          enum: [Open, InProgress, Done]
        priority:
          type: string
          enum: [Low, Normal, High, Urgent]
        dueDate:
          type: string
          format: date
          nullable: true
        assignedTo:
          type: string

    # ── Timeline Schemas (NEW) ──────────────────────────────────
    TimelineEvent:
      type: object
      description: Activity timeline event for the activity feed.
      required:
        - id
        - entityType
        - entityId
        - eventType
        - occurredAt
      properties:
        id:
          type: string
          format: uuid
        entityType:
          type: string
          description: Type of entity this event relates to.
          example: Broker
        entityId:
          type: string
          format: uuid
        eventType:
          type: string
          description: Machine-readable event type.
          example: BrokerCreated
        eventDescription:
          type: string
          description: Human-readable event summary.
          example: New broker added by Sarah Chen
        entityName:
          type: string
          description: Resolved name of the related entity.
          example: Pacific Reinsurance
        actorDisplayName:
          type: string
          description: Display name of the user who performed the action.
          example: Sarah Chen
        occurredAt:
          type: string
          format: date-time
